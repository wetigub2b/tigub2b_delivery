# 配送流程文档
## table 
**tigu_prepare_goods**:  

prepared packages for driver to work on

**tigu_prepare_goods_item**: 

the items in the prepared packages  
(can be used for display detail items of the package)

** tigu_order_action **:

   订单所有流程操作，凭证需要记录在tigu_order_action表，同时需要同步修改订单表中的状态以及备货表的状态。Tigu_order_action每次操作（备货完成，司机收货，送达仓库等）新增一条数据。
	tigu_order_action必填字段：
   id（雪花算法ID）,
   create_by（创建人，当前操作人）,
   create_time（创建时间）,
   order_id（本次操作关联的订单ID）,
action_type（操作类型(0备货，1司机收货，2仓库收货，3仓库发货，4完成，5用户申请退款，6商家允许退货 7商家不允许退货 8商家同意退款 9商家拒绝退款 10用户退货信息凭证11.司机送达仓库)）,
logistics_voucher_file（文件ID列表，多个用,分割，tigu_uploaded_files表的id）

** tigu_uploaded_files **

字段：
id（雪花算法ID），file_name（文件名称），file_url（文件完整路径），file_size（文件大小），biz_id（文件关联的相关ID，如商品图片，biz_type=product_sku，biz_id=商品SKU的id）


## 概述

业务角色包括三种：**商家**、**司机**、**仓库**

商城订单中，配送分为 4 种情况(table tigu_prepare_goods)：

1. 商家自行配送，货物配送到仓库 (delivery_type 0, shipping type 0)
2. 商家自行配送，货物配送到用户 (delivery type 0, shippgin type 1)
3. 第三方配送，货物配送到仓库 (delivery type 1, shipping type 0)
4. 第三方配送，货物配送到用户 (delivery type 1, shipping type 1)

用户成功下单后进入商家订单。商家操作第一步：备货。商家选择一个或者多个订单，提交备货完成，备货完成。选择本次备货为自行配送，或者第三方配送，以及发货到仓库或者发货到用户，并上传凭证，修改订单、备货状态。

---

## 流程 1：商家自行配送，货物配送到仓库

### 流程描述

1. **商家备货**
   - 商家线下将货物配送到指定仓库
   - 商家后台提交货物送达凭证
   - 同步修改订单备货表状态、保存凭证

2. **仓库收货**
   - 仓库将货物配送到用户手中
   - 仓库发货前，需要在后台管理中添加货物凭证
   - 同步修改订单备货表状态、保存凭证

3. **用户收货**
   - 货物送达到用户后
   - 仓库需要上传货物送达凭证
   - 同步修改订单备货表状态、保存凭证

### 流程图

```mermaid
graph TD
    A[用户下单] --> B[商家接单]
    B --> C[商家备货]
    C --> D[商家线下配送到仓库]
    D --> E[商家上传送达凭证]
    E --> F{仓库确认收货}
    F --> G[更新订单状态]
    G --> H[仓库配送到用户]
    H --> I[仓库上传发货凭证]
    I --> J[货物送达用户]
    J --> K[仓库上传送达凭证]
    K --> L[订单完成]

    style A fill:#e1f5ff
    style L fill:#c8e6c9
    style F fill:#fff9c4
```

### 状态流转

```mermaid
stateDiagram-v2
    [*] --> 待备货: 用户下单
    待备货 --> 备货中: 商家开始备货
    备货中 --> 已备货: 商家备货完成
    已备货 --> 配送中_仓库: 商家配送到仓库
    配送中_仓库 --> 仓库已收货: 仓库确认收货
    仓库已收货 --> 配送中_用户: 仓库配送到用户
    配送中_用户 --> 已送达: 用户收货
    已送达 --> [*]: 订单完成
```

---

## 流程 2：商家自行配送，货物配送到用户

### 流程描述

1. **商家备货并配送**
   - 商家后台操作发货，提交发货凭证
   - 同步修改订单备货表状态、保存凭证

2. **货物送达用户**
   - 货物成功送达用户
   - 商家后台提交商品送达凭证
   - 同步修改订单备货表状态、保存凭证

### 流程图

```mermaid
graph TD
    A[用户下单] --> B[商家接单]
    B --> C[商家备货]
    C --> D[商家自行配送]
    D --> E[商家上传发货凭证]
    E --> F[货物送达用户]
    F --> G[商家上传送达凭证]
    G --> H[订单完成]

    style A fill:#e1f5ff
    style H fill:#c8e6c9
```

### 状态流转

```mermaid
stateDiagram-v2
    [*] --> 待备货: 用户下单
    待备货 --> 备货中: 商家开始备货
    备货中 --> 已备货: 商家备货完成
    已备货 --> 配送中: 商家开始配送
    配送中 --> 已送达: 用户收货
    已送达 --> [*]: 订单完成
```

---

## 流程 3：第三方配送，货物配送到仓库

### 流程描述

1. **司机接单**
   - 司机端可接订单
   - 由司机收货，司机到达商家，收取货物
   - 上传收货凭证
   - 同步修改订单备货表状态、保存凭证

2. **司机配送到仓库**
   - 司机将商品送达仓库
   - 司机上传凭证
   - 同步修改订单备货表状态、保存凭证

3. **仓库收货并配送**
   - 仓库将货物配送到用户手中
   - 仓库发货前，需要在后台管理中添加货物凭证
   - 同步修改订单备货表状态、保存凭证

4. **用户收货**
   - 货物送达到用户后
   - 仓库需要上传货物送达凭证
   - 同步修改订单备货表状态、保存凭证

### 流程图

```mermaid
graph TD
    A[用户下单] --> B[商家接单]
    B --> C[商家备货]
    C --> D[司机接单]
    D --> E[司机到达商家]
    E --> F[司机收货]
    F --> G[司机上传收货凭证]
    G --> H[司机配送到仓库]
    H --> I[司机上传送达凭证]
    I --> J{仓库确认收货}
    J --> K[更新订单状态]
    K --> L[仓库配送到用户]
    L --> M[仓库上传发货凭证]
    M --> N[货物送达用户]
    N --> O[仓库上传送达凭证]
    O --> P[订单完成]

    style A fill:#e1f5ff
    style P fill:#c8e6c9
    style D fill:#ffe0b2
    style J fill:#fff9c4
```

### 状态流转

```mermaid
stateDiagram-v2
    [*] --> 待备货: 用户下单
    待备货 --> 备货中: 商家开始备货
    备货中 --> 已备货: 商家备货完成
    已备货 --> 待司机接单: 选择第三方配送
    待司机接单 --> 司机已接单: 司机接单
    司机已接单 --> 司机收货中: 司机到达商家
    司机收货中 --> 司机配送中: 司机收货完成
    司机配送中 --> 仓库已收货: 司机送达仓库
    仓库已收货 --> 配送中_用户: 仓库配送到用户
    配送中_用户 --> 已送达: 用户收货
    已送达 --> [*]: 订单完成
```

---

## 流程 4：第三方配送，货物配送到用户

### 流程描述

1. **司机接单并收货**
   - 司机端可接单
   - 并将货物送达用户
   - 司机首先需要到商家出收货，收货需要上传凭证
   - 同步修改订单备货表状态、保存凭证

2. **司机配送到用户**
   - 司机将货物成功送达到用户
   - 上传凭证
   - 同步修改订单备货表状态、保存凭证

### 流程图

```mermaid
graph TD
    A[用户下单] --> B[商家接单]
    B --> C[商家备货]
    C --> D[司机接单]
    D --> E[司机到达商家]
    E --> F[司机收货]
    F --> G[司机上传收货凭证]
    G --> H[司机配送到用户]
    H --> I[货物送达用户]
    I --> J[司机上传送达凭证]
    J --> K[订单完成]

    style A fill:#e1f5ff
    style K fill:#c8e6c9
    style D fill:#ffe0b2
```

### 状态流转

```mermaid
stateDiagram-v2
    [*] --> 待备货: 用户下单
    待备货 --> 备货中: 商家开始备货
    备货中 --> 已备货: 商家备货完成
    已备货 --> 待司机接单: 选择第三方配送
    待司机接单 --> 司机已接单: 司机接单
    司机已接单 --> 司机收货中: 司机到达商家
    司机收货中 --> 司机配送中: 司机收货完成
    司机配送中 --> 已送达: 用户收货
    已送达 --> [*]: 订单完成
```

---

## 流程对比总览

```mermaid
graph TB
    subgraph 流程选择
        A[用户下单] --> B{配送方式选择}
        B --> |商家自配| C{配送目的地}
        B --> |第三方配送| D{配送目的地}

        C --> |到仓库| E[流程1: 商家→仓库→用户]
        C --> |到用户| F[流程2: 商家→用户]

        D --> |到仓库| G[流程3: 司机→仓库→用户]
        D --> |到用户| H[流程4: 司机→用户]
    end

    style A fill:#e1f5ff,color:#1a1a1a
    style B fill:#fff9c4,color:#1a1a1a
    style C fill:#fff9c4,color:#1a1a1a
    style D fill:#fff9c4,color:#1a1a1a
    style E fill:#c8e6c9,color:#1a1a1a
    style F fill:#c8e6c9,color:#1a1a1a
    style G fill:#ffccbc,color:#1a1a1a
    style H fill:#ffccbc,color:#1a1a1a
```

---

## 角色职责

### 商家
- 接收订单
- 备货
- 自行配送（流程 1、2）或等待司机取货（流程 3、4）
- 上传相关凭证

### 司机（第三方配送）
- 接单
- 到商家处收货
- 配送到仓库或用户
- 上传收货和送达凭证

### 仓库
- 接收商家或司机送来的货物
- 二次配送到用户
- 上传发货和送达凭证

### 用户
- 下单
- 接收货物

---

## 凭证管理

所有流程中都需要上传以下凭证：

1. **收货凭证**：确认货物已从商家处取出
2. **发货凭证**：确认货物已发往下一环节
3. **送达凭证**：确认货物已送达目的地

每次凭证上传都会同步更新订单备货表状态。

---

## 订单状态说明
tigu_prepare_goods: column ：prepare_status
| 状态 | 说明 |
|------|------|
| 待备货 | 订单已生成，等待商家备货 （null）|
| 已备货 | 商家备货完成(商家备货完成拍照) （0） |
| 司机收货中 | 司机正在商家处收货(司机收货拍照) （1） |
| 司机收货完成送货仓库 | 司机送货到仓库(司机送达拍照) （2）|
| 仓库已收货 | 仓库已确认收货(仓库管理拍照) (3)|
| 司机配送到用户 | 货物正在送往用户(司机收货拍照) (4) |
| 已送达 | 货物已送达最终用户(司机拍照) (5)|
| 订单完成 | 订单流程全部完成 (6)|
